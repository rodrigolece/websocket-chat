<!DOCTYPE html>
<html>

<head>
<title>Canvas Web Server</title>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script type="text/javascript">
    $(function() {

    var conn;
    var ownID;
    var connected = [];
    var log = $("#log");

    function appendLog(msg) {
        var d = log[0]
        var doScroll = d.scrollTop == d.scrollHeight - d.clientHeight;
        msg.appendTo(log)
        if (doScroll) {
            d.scrollTop = d.scrollHeight - d.clientHeight;
        }
    }

    addEventListener("keydown", function(evt) {
        var direction = null;
        // Left arrow
        if (evt.keyCode == 37) {
            direction = "left";
            evt.preventDefault();
        }
        // Right arrow
        if (evt.keyCode == 39) {
            direction = "right";
            evt.preventDefault();
        }

        if (direction != null) {
            var data =  {
                Type: "turn",
                Content: direction
            }

            gas.particles[0].turn(direction);

            broadcastEvent(data);
        }

        // n key --> new gas
        if (evt.keyCode == 78) {
            gas = new Gas(numParticles, lx - minD, ly - minD);
            drawParticles(gas);
        }
    });
    addEventListener("keyup", function(evt) {
        // Left or right arrow
        if (evt.keyCode == 37 || evt.keyCode == 39) {
            var data =  { Type: "stopturn" }
            broadcastEvent(data);
            evt.preventDefault();
        }
    });

    function broadcastEvent(data) {
        if (!conn) {
            return false;
        }
        var j = JSON.stringify({
            Action: "broadcast",
            Data: data
        });
        conn.send(j);
        return false
    }


    if (window["WebSocket"]) {
        // Dirección metida a mano abajo
        conn = new WebSocket("ws://127.0.0.1:8080/ws");
        conn.onclose = function(evt) {
            appendLog($("<div><b>Connection closed.</b></div>"))
        }
        conn.onmessage = function(evt) {
            var wsEvent = JSON.parse(evt.data);
            if (wsEvent.Action == "read") {
                appendLog($("<div/>").wsEvent.Data.Content)
            }
            if (wsEvent.Action == "registerown") {
                ownID = wsEvent.Data.Content;
                var j = JSON.stringify({Action: "registerownOK"});
                conn.send(j);
            }
            if (wsEvent.Action == "register") {
                var id = wsEvent.Data.Content;
                // register se hace en broadcast así que ignoramos nuestra propia id
                if (id != ownID) {
                    connected.push(id);
                }
            }
        }
    } else {
        appendLog($("<div><b>Your browser does not support WebSockets.</b></div>"))
    }

    });

</script>
<style>
#log {
    float:right;
    width:300;
    height:600;
    padding: 1em;
    border: 1px solid #d3d3d3;
}
</style>
</head>

<body>
<canvas id="canvas" width="600" height="600" style="border:1px solid #d3d3d3;">
</canvas>
<div id="log"></div>

<script src="/static/gas.js"></script>

</body>

</html>
