<!DOCTYPE html>
<html>

<head>
<title>Canvas Web Server</title>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script type="text/javascript">
    $(function() {

    var conn;
    var ownID;
    var connected = [];

    var log = $("#log");

    var self;

    function appendLog(msg) {
        var d = log[0]
        var doScroll = d.scrollTop == d.scrollHeight - d.clientHeight;
        msg.appendTo(log)
        if (doScroll) {
            d.scrollTop = d.scrollHeight - d.clientHeight;
        }
    }

    addEventListener("keydown", function(evt) {
        var direction = null;
        // Left arrow
        if (evt.keyCode == 37) {
            direction = "left";
            evt.preventDefault();
        }
        // Right arrow
        if (evt.keyCode == 39) {
            direction = "right";
            evt.preventDefault();
        }
        // Up arrow
        if (evt.keyCode == 38) {
            direction = "up";
            evt.preventDefault();
        }
        // Down arrow
        if (evt.keyCode == 40) {
            direction = "down";
            evt.preventDefault();
        }

        if (direction != null) {
            var data =  [
                {
                    Type: "turn",
                    Content: direction
                }
            ];
            broadcastEvent(data);

            // self guarda el índice de la partícula del cliente
            gas.particles[self].changeVel(direction);
        }

        /*
        // d key --> add particle
        if (evt.keyCode == 68) {
            gas.addParticle();
        }
        // n key --> new gas
        if (evt.keyCode == 78) {
            gas.addParticle();
        }
        */
    });
    /* Tal vez esto no se necesita
    addEventListener("keyup", function(evt) {
        // Left or right arrow
        if (evt.keyCode == 37 || evt.keyCode == 39) {
            var data =  [{ Type: "stopturn" }];
            broadcastEvent(data);
            evt.preventDefault();
        }
    });*/

    function broadcastEvent(data) {
        if (!conn) {
            return false;
        }
        var j = JSON.stringify({
            Action: "broadcast",
            Data: data
        });
        conn.send(j);
        return false
    }


    if (window["WebSocket"]) {
        // Dirección metida a mano abajo
        conn = new WebSocket("ws://127.0.0.1:8080/ws");
        conn.onclose = function(evt) {
            appendLog($("<div><b>Connection closed.</b></div>"))
        }
        conn.onmessage = function(evt) {
            var wsEvent = JSON.parse(evt.data);
            if (wsEvent.Action == "readmessage") {
                appendLog($("<div/>").wsEvent.Data[0].Content)
            }
            if (wsEvent.Action == "registerown") {
                ownID = wsEvent.Data[0].Content;
                var j = JSON.stringify({
                    Action: "registerownOK",
                    // Data es necesario porque en el servidor tomamos el primer
                    // elemento siempre
                    Data: [
                        {
                            Type: "",
                            Content: ""
                        }
                    ]
                });
                conn.send(j);

                // Agregamos una nueva partícula
                self = gas.addParticle();
                var pos = gas.particles[self].pos;
                var vel = gas.particles[self].vel;

                // Mandamos al servidor la posición y velocidad
                var data =  [
                    {
                        Type: "pos",
                        Content: {x: pos.x, y: pos.y}
                    },
                    {
                        Type: "vel",
                        Content: {vx: vel.vx, vy: vel.vy}
                    }
                ];
                broadcastEvent(data);
            }
            if (wsEvent.Action == "register") {
                var id = wsEvent.Data[0].Content;
                // register se hace en broadcast así que ignoramos nuestra propia id
                if (id != ownID) {
                    connected.push(id);
                }
            }
        }
    } else {
        appendLog($("<div><b>Your browser does not support WebSockets.</b></div>"))
    }

    });

</script>
<style>
#log {
    float:right;
    width:300;
    height:600;
    padding: 1em;
    border: 1px solid #d3d3d3;
}
</style>
</head>

<body>
<canvas id="canvas" width="600" height="600" style="border:1px solid #d3d3d3;">
</canvas>
<div id="log"></div>

<script src="/static/gas.js"></script>

</body>

</html>
